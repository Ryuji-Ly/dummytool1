services:
    traefik:
        image: traefik:v3.1
        container_name: traefik
        restart: unless-stopped
        command:
            - --api.dashboard=true
            - --providers.docker=true
            - --providers.docker.exposedbydefault=false
            - --entrypoints.web.address=:80
            - --entrypoints.websecure.address=:443
            - --certificatesresolvers.myresolver.acme.httpchallenge=true
            - --certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=web
            - --certificatesresolvers.myresolver.acme.email=alankim017@gmail.com
            - --certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json
        ports:
            - "8080:80"
            - "8443:443"
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock:ro
            - ./letsencrypt:/letsencrypt
        networks:
            - app-network

    app:
        build: .
        container_name: dummytool1
        restart: unless-stopped
        environment:
            - NODE_ENV=production
            - NEXTAUTH_URL=https://dummytool1.duckdns.org
            - NEXTAUTH_SECRET=gqtiegBqprRUhZvcMEYEiZyZYOIKsipo
            - KEYCLOAK_ISSUER=https://keycloakucll.duckdns.org/realms/ucll
            - KEYCLOAK_CLIENT_ID=dummytool1
            - KEYCLOAK_CLIENT_SECRET=zt7H3jD6cnkHFqVZcsXfuzKJtMusG2Ot
        ports:
            - "3000:3000"
        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.app.rule=Host(`dummytool1.duckdns.org`)"
            - "traefik.http.routers.app.entrypoints=websecure"
            - "traefik.http.routers.app.tls.certresolver=myresolver"
            - "traefik.http.services.app.loadbalancer.server.port=3000"
            - "traefik.http.routers.app-http.rule=Host(`dummytool1.duckdns.org`)"
            - "traefik.http.routers.app-http.entrypoints=web"
            - "traefik.http.routers.app-http.middlewares=redirect-to-https"
            - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
        networks:
            - app-network

volumes:
    letsencrypt:

networks:
    app-network:
        driver: bridge
